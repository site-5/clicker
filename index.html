<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Global Clicker Debug</title>
    <!-- 1. Try a different CDN for the Supabase library -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; background: #f0f2f5; }
        #counter { font-size: 5rem; margin-bottom: 5px; color: #1e293b; }
        #last-clicked { font-size: 1.2rem; margin-bottom: 20px; color: #64748b; font-weight: bold; }
        button { padding: 15px 40px; font-size: 1.5rem; cursor: pointer; background: #3b82f6; color: white; border: none; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="counter">loading...</div>
    <div id="last-clicked">Waiting for data...</div>
    <button id="click-btn">CLICK ME</button>

    <script>
        // Use a timeout to ensure everything is loaded
        window.onload = async function() {
            // NEW: Prompt for name before starting
            let userName = prompt("Enter your name to start clicking:") || "Anonymous";

            const counterDisplay = document.getElementById('counter');
            const nameDisplay = document.getElementById('last-clicked');
            
            // STEP 1: Check if Supabase library exists
            if (!window.supabase) {
                alert("CRITICAL ERROR: Supabase library failed to load! Check your internet or disable AdBlock.");
                return;
            }

            const SUPABASE_URL = 'https://dhtqvsdojuoxzfewtxld.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRodHF2c2RvanVveHpmZXd0eGxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNTkxMzQsImV4cCI6MjA4MzczNTEzNH0.MAcxrDMZQ20kQXv-nk3zvNGMQlP9-BR97UYT5p_W7Fg';
            
            let supabase;
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch (e) {
                alert("Client Init Error: " + e.message);
            }

            // STEP 2: Attempt to fetch data with a timeout
            async function fetchCount() {
                console.log("Attempting fetch...");
                try {
                    // UPDATED: Now selecting last_name as well
                    const { data, error } = await supabase
                        .from('clicks')
                        .select('count, last_name')
                        .eq('id', 1)
                        .single();

                    if (error) {
                        alert("Database Query Error: " + error.message + "\nCode: " + error.code);
                        counterDisplay.innerText = "DB Error";
                    } else if (data) {
                        counterDisplay.innerText = data.count;
                        // NEW: Update name display
                        nameDisplay.innerText = "Last Clicked By: " + (data.last_name || "None");
                    } else {
                        alert("Fetch successful, but NO DATA found. Did you insert the row with ID 1?");
                        counterDisplay.innerText = "No Row";
                    }
                } catch (e) {
                    alert("Network/Script Crash: " + e.message);
                }
            }

            // STEP 3: Handle Clicks
            document.getElementById('click-btn').addEventListener('click', async () => {
                const current = parseInt(counterDisplay.innerText) || 0;
                
                // Optimistic UI updates
                counterDisplay.innerText = current + 1; 
                nameDisplay.innerText = "Last Clicked By: " + userName;

                // UPDATED: Now updating last_name in the database
                const { error } = await supabase
                    .from('clicks')
                    .update({ 
                        count: current + 1,
                        last_name: userName
                    })
                    .eq('id', 1);

                if (error) alert("Update Failed: " + error.message);
            });

            // STEP 4: Realtime
            supabase.channel('any')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clicks' }, payload => {
                    if (payload.new && payload.new.count !== undefined) {
                        counterDisplay.innerText = payload.new.count;
                        // NEW: Update name in realtime
                        nameDisplay.innerText = "Last Clicked By: " + (payload.new.last_name || "Anonymous");
                    }
                })
                .subscribe();

            // Run the initial fetch
            fetchCount();
        };
    </script>
</body>
</html>
