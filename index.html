<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Global Clicker</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); 
            margin: 0; 
            padding: 20px; 
            overflow-x: hidden;
            color: white;
            cursor: crosshair; /* Themed cursor */
        }

        /* NEW: Cursor & Trail Styles */
        .remote-cursor {
            position: fixed;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: transform 0.05s linear;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .cursor-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 800;
            white-space: nowrap;
            text-transform: uppercase;
        }
        .trail {
            position: fixed;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: fadeOut 0.6s forwards;
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.1) translateY(10px); }
        }

        /* Animated Stars Background */
        .stars-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: twinkle var(--duration) infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        #counter { 
            font-size: 6rem; 
            margin-bottom: 5px; 
            color: #facc15; 
            text-shadow: 0 0 30px rgba(250, 204, 21, 0.4);
            font-weight: 800;
            user-select: none;
        }

        #last-clicked { 
            font-size: 1rem; 
            margin-bottom: 25px; 
            color: #94a3b8; 
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(255,255,255,0.05);
            padding: 8px 25px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
            user-select: none;
        }

        button#click-btn { 
            padding: 20px 60px; 
            font-size: 2.2rem; 
            cursor: pointer; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 16px; 
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.3);
            font-weight: bold;
        }

        button#click-btn:hover { background: #2563eb; transform: translateY(-2px); }
        button#click-btn:active { transform: scale(0.95); }

        /* Initial Name Screen */
        #name-overlay { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: #090A0F; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            color: white; 
        }
        
        #name-overlay h1 { font-size: 4rem; color: #facc15; margin-bottom: 20px; text-shadow: 0 0 20px rgba(250, 204, 21, 0.3); }

        #name-overlay input { 
            padding: 18px; 
            font-size: 1.4rem; 
            border-radius: 12px; 
            border: 2px solid #334155; 
            background: #1e293b;
            color: white;
            margin-bottom: 25px; 
            width: 350px; 
            text-align: center; 
            outline: none;
        }

        #name-overlay button { 
            background: #10b981; 
            padding: 16px 50px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        /* Shop Section */
        #game-container { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 700px; padding-bottom: 50px; }
        
        .shop { 
            margin-top: 50px; 
            width: 100%; 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(12px);
            padding: 30px; 
            border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
        }

        .shop h2 { margin: 0 0 20px 0; font-size: 1.8rem; color: #facc15; }
        
        .upgrade-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 18px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }

        .upgrade-info { display: flex; flex-direction: column; gap: 4px; }
        .upgrade-info b { font-size: 1.1rem; color: #f8fafc; }
        .upgrade-info span { font-size: 0.85rem; color: #64748b; font-weight: 500; }

        .buy-btn { 
            padding: 12px 24px; 
            font-size: 1rem; 
            background: #10b981; 
            color: white;
            border: none;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            min-width: 120px;
            transition: all 0.2s;
        }

        .buy-btn:hover:not(:disabled) { background: #059669; }
        .buy-btn:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        
        #global-stats { margin-top: 20px; font-size: 1.1rem; color: #94a3b8; font-weight: 600; }
        #last-purchase { font-size: 0.9rem; color: #fb7185; margin-bottom: 20px; font-weight: 700; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="stars-container" id="stars"></div>
    <div id="cursor-container"></div> <!-- Container for remote users -->

    <!-- INITIAL SCREEN -->
    <div id="name-overlay">
        <h1>GLOBAL CLICKER</h1>
        <input type="text" id="name-input" placeholder="Your Name" maxlength="15">
        <button id="start-btn">ENTER GAME</button>
    </div>

    <!-- MAIN GAME -->
    <div id="game-container">
        <div id="counter">0</div>
        <div id="last-clicked">Awaiting Data...</div>
        <button id="click-btn">CLICK</button>
        
        <div id="global-stats">Auto Rate: <span id="auto-rate-val" style="color:#facc15">0</span> CPS</div>

        <div class="shop">
            <h2>Upgrades</h2>
            <div id="last-purchase">Last Purchase: None</div>
            
            <div id="upgrade-list">
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Small Satellite (+0.1)</b><span id="u1-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(0.1, 50, 'u1')">50</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Lunar Base (+1.0)</b><span id="u2-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(1, 400, 'u2')">400</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Fusion Reactor (+10)</b><span id="u3-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(10, 3000, 'u3')">3000</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Solar Array (+50)</b><span id="u4-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(50, 15000, 'u4')">15000</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Deep Space Hub (+200)</b><span id="u5-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(200, 80000, 'u5')">80000</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Star Factory (+800)</b><span id="u6-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(800, 400000, 'u6')">400000</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Nebula Harvester (+2.5k)</b><span id="u7-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(2500, 1500000, 'u7')">1.5M</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Galactic Pulse (+8k)</b><span id="u8-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(8000, 8000000, 'u8')">8M</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Void Engine (+25k)</b><span id="u9-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(25000, 50000000, 'u9')">50M</button>
                </div>
                <div class="upgrade-card">
                    <div class="upgrade-info"><b>Singularity (+100k)</b><span id="u10-last">Last Buyer: None</span></div>
                    <button class="buy-btn" onclick="buyUpgrade(100000, 250000000, 'u10')">250M</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Star Background Generation
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 150; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            const size = (Math.random() * 2 + 1) + 'px';
            star.style.width = size;
            star.style.height = size;
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
            star.style.animationDelay = Math.random() * 5 + 's';
            starsContainer.appendChild(star);
        }

        window.onload = async function() {
            if (!window.supabase) {
                alert("Library Error: Check internet connection.");
                return;
            }

            const SUPABASE_URL = 'https://dhtqvsdojuoxzfewtxld.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRodHF2c2RvanVveHpmZXd0eGxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNTkxMzQsImV4cCI6MjA4MzczNTEzNH0.MAcxrDMZQ20kQXv-nk3zvNGMQlP9-BR97UYT5p_W7Fg';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            const counterDisplay = document.getElementById('counter');
            const nameDisplay = document.getElementById('last-clicked');
            const gameContainer = document.getElementById('game-container');
            const nameOverlay = document.getElementById('name-overlay');
            const nameInput = document.getElementById('name-input');
            const rateDisplay = document.getElementById('auto-rate-val');
            
            let userName = "";

            // NEW: Cursor logic variables
            const cursors = {};
            const cursorContainer = document.getElementById('cursor-container');

            function getCursorColor(name) {
                const n = name.toLowerCase();
                if (n === 'grace') return '#FFD700'; // Gold
                if (n === 'derrick') return '#000080'; // Navy Blue
                return '#FFFFFF';
            }

            function createTrail(x, y, color) {
                const trail = document.createElement('div');
                trail.className = 'trail';
                trail.style.left = x + 'px';
                trail.style.top = y + 'px';
                trail.style.backgroundColor = color;
                trail.style.boxShadow = `0 0 8px ${color}`;
                document.body.appendChild(trail);
                setTimeout(() => trail.remove(), 600);
            }

            document.getElementById('start-btn').onclick = function() {
                userName = nameInput.value.trim();
                if(!userName) { alert("Enter a name!"); return; }
                nameOverlay.style.display = "none";
                gameContainer.style.display = "flex";
                
                // Track mouse and broadcast
                document.addEventListener('mousemove', (e) => {
                    const color = getCursorColor(userName);
                    if (userName.toLowerCase() === 'grace' || userName.toLowerCase() === 'derrick') {
                        createTrail(e.clientX, e.clientY, color);
                    }
                    supabase.channel('cursors').send({
                        type: 'broadcast',
                        event: 'move',
                        payload: { x: e.clientX, y: e.clientY, name: userName }
                    });
                });

                fetchCount();
            };

            // NEW: Listen for mouse movement from others
            supabase.channel('cursors').on('broadcast', { event: 'move' }, ({ payload }) => {
                if (payload.name === userName) return;

                if (!cursors[payload.name]) {
                    const el = document.createElement('div');
                    el.className = 'remote-cursor';
                    el.style.backgroundColor = getCursorColor(payload.name);
                    el.innerHTML = `<div class="cursor-label">${payload.name}</div>`;
                    cursorContainer.appendChild(el);
                    cursors[payload.name] = el;
                }

                const cursorEl = cursors[payload.name];
                cursorEl.style.left = payload.x + 'px';
                cursorEl.style.top = payload.y + 'px';

                // Trails for others
                const pName = payload.name.toLowerCase();
                if (pName === 'grace' || pName === 'derrick') {
                    createTrail(payload.x, payload.y, getCursorColor(payload.name));
                }
            }).subscribe();

            async function fetchCount() {
                const { data, error } = await supabase.from('clicks').select('*').eq('id', 1).single();
                if (data) updateUI(data);
            }

            function updateUI(data) {
                counterDisplay.innerText = Math.floor(data.count).toLocaleString();
                nameDisplay.innerText = "Last Clicked By: " + (data.last_name || "None");
                rateDisplay.innerText = (data.auto_rate || 0).toLocaleString();
                document.getElementById('last-purchase').innerText = "Last Purchase: " + (data.last_purchase_name || "None");
                
                for(let i=1; i<=10; i++) {
                    const el = document.getElementById(`u${i}-last`);
                    if(el) el.innerText = "Last Buyer: " + (data[`last_u${i}_name`] || "None");
                }
                
                const costs = [50, 400, 3000, 15000, 80000, 400000, 1500000, 8000000, 50000000, 250000000];
                document.querySelectorAll('.buy-btn').forEach((btn, idx) => {
                    btn.disabled = data.count < costs[idx];
                });
            }

            window.buyUpgrade = async function(rateAdd, cost, column) {
                const currentCount = parseFloat(counterDisplay.innerText.replace(/,/g, ''));
                if(currentCount < cost) return;

                const { error } = await supabase.from('clicks').update({
                    count: currentCount - cost,
                    auto_rate: parseFloat(rateDisplay.innerText.replace(/,/g, '')) + rateAdd,
                    last_purchase_name: userName,
                    [`last_${column}_name`]: userName
                }).eq('id', 1);
                if(error) alert("Purchase Error: " + error.message);
            }

            document.getElementById('click-btn').addEventListener('click', async () => {
                const current = parseFloat(counterDisplay.innerText.replace(/,/g, '')) || 0;
                counterDisplay.innerText = (current + 1).toLocaleString();
                nameDisplay.innerText = "Last Clicked By: " + userName;

                await supabase.from('clicks').update({ count: current + 1, last_name: userName }).eq('id', 1);
            });

            setInterval(async () => {
                const rate = parseFloat(rateDisplay.innerText.replace(/,/g, '')) || 0;
                if(rate > 0) {
                    await supabase.rpc('increment_auto_clicks', { amount: rate });
                }
            }, 1000);

            supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'clicks' }, payload => {
                if (payload.new) updateUI(payload.new);
            }).subscribe();
        };
    </script>
</body>
</html>
