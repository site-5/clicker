<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Global Clicker: Star Edition</title>
    <!-- 1. Supabase Library -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* EXISTING STYLES + STAR THEME OVERRIDES */
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); 
            margin: 0; 
            padding: 20px; 
            overflow-x: hidden;
            color: white;
        }

        /* Animated Stars Background */
        .stars-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* Create 3 layers of stars with different speeds */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: twinkle var(--duration) infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        #counter { 
            font-size: 6rem; 
            margin-bottom: 5px; 
            color: #facc15; 
            text-shadow: 0 0 20px rgba(250, 204, 21, 0.5);
            font-weight: bold;
        }

        #last-clicked { 
            font-size: 1.2rem; 
            margin-bottom: 20px; 
            color: #94a3b8; 
            font-weight: bold; 
            background: rgba(255,255,255,0.05);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        button#click-btn { 
            padding: 20px 50px; 
            font-size: 2rem; 
            cursor: pointer; 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: white; 
            border: none; 
            border-radius: 15px; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
        }

        button#click-btn:active { transform: scale(0.9); box-shadow: 0 0 10px rgba(59, 130, 246, 0.6); }

        /* Initial Name Screen */
        #name-overlay { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: #090A0F; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            color: white; 
        }
        
        #name-overlay h1 { font-size: 3.5rem; color: #facc15; margin-bottom: 10px; text-shadow: 0 0 15px rgba(250, 204, 21, 0.4); }

        #name-overlay input { 
            padding: 15px; 
            font-size: 1.5rem; 
            border-radius: 12px; 
            border: 2px solid #334155; 
            background: #1e293b;
            color: white;
            margin-bottom: 20px; 
            width: 320px; 
            text-align: center; 
            outline: none;
        }

        #name-overlay button { 
            background: #10b981; 
            padding: 15px 40px;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        /* Shop Section */
        #game-container { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 650px; }
        
        .shop { 
            margin-top: 40px; 
            width: 100%; 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px);
            padding: 25px; 
            border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }

        .shop h2 { margin-top: 0; color: #facc15; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        
        .upgrade-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }

        .upgrade-info { display: flex; flex-direction: column; }
        .upgrade-info b { font-size: 1.15rem; color: #f8fafc; }
        .upgrade-info span { font-size: 0.85rem; color: #94a3b8; }

        .buy-btn { 
            padding: 10px 20px; 
            font-size: 1rem; 
            background: #10b981; 
            font-weight: bold;
            border-radius: 8px;
        }

        .buy-btn:disabled { background: #334155; color: #64748b; cursor: not-allowed; opacity: 0.6; }
        
        #global-stats { margin-top: 15px; font-size: 1rem; color: #94a3b8; font-weight: bold; }
        #last-purchase { font-size: 0.95rem; color: #fb7185; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="stars-container" id="stars"></div>

    <!-- INITIAL SCREEN: User must enter name -->
    <div id="name-overlay">
        <h1>ðŸŒŸ STAR CLICKER</h1>
        <p style="color: #94a3b8;">The universe is waiting for your input.</p>
        <input type="text" id="name-input" placeholder="Enter Pilot Name..." maxlength="15">
        <button id="start-btn">IGNITE ENGINES</button>
    </div>

    <!-- MAIN GAME -->
    <div id="game-container">
        <div id="counter">loading...</div>
        <div id="last-clicked">Awaiting Data Transmission...</div>
        <button id="click-btn">GENERATE STARLIGHT</button>
        
        <div id="global-stats">Celestial Auto-Rate: <span id="auto-rate-val" style="color:#facc15">0</span> CPS</div>

        <!-- Shop Section -->
        <div class="shop">
            <h2>Cosmic Shipments</h2>
            <div id="last-purchase">Recent Discovery: None</div>
            
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <b>Micro-Satellite (+0.1/s)</b>
                    <span id="u1-last">Last Buyer: None</span>
                </div>
                <button class="buy-btn" onclick="buyUpgrade(0.1, 50, 'u1')">Buy: 50</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <b>Lunar Outpost (+1/s)</b>
                    <span id="u2-last">Last Buyer: None</span>
                </div>
                <button class="buy-btn" onclick="buyUpgrade(1, 400, 'u2')">Buy: 400</button>
            </div>

            <div class="upgrade-card">
                <div class="upgrade-info">
                    <b>Fusion Reactor (+10/s)</b>
                    <span id="u3-last">Last Buyer: None</span>
                </div>
                <button class="buy-btn" onclick="buyUpgrade(10, 3000, 'u3')">Buy: 3000</button>
            </div>
        </div>
    </div>

    <script>
        // Generate Stars Background
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 150; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            const size = Math.random() * 3 + 'px';
            star.style.width = size;
            star.style.height = size;
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
            star.style.animationDelay = Math.random() * 5 + 's';
            starsContainer.appendChild(star);
        }

        window.onload = async function() {
            // STEP 1: Supabase Initialization
            if (!window.supabase) {
                alert("CRITICAL ERROR: Supabase library failed to load! Disable AdBlock.");
                return;
            }

            const SUPABASE_URL = 'https://dhtqvsdojuoxzfewtxld.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRodHF2c2RvanVveHpmZXd0eGxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNTkxMzQsImV4cCI6MjA4MzczNTEzNH0.MAcxrDMZQ20kQXv-nk3zvNGMQlP9-BR97UYT5p_W7Fg';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            const counterDisplay = document.getElementById('counter');
            const nameDisplay = document.getElementById('last-clicked');
            const gameContainer = document.getElementById('game-container');
            const nameOverlay = document.getElementById('name-overlay');
            const nameInput = document.getElementById('name-input');
            
            let userName = "";

            // Handle Game Start
            document.getElementById('start-btn').onclick = function() {
                userName = nameInput.value.trim();
                if(!userName) { alert("Pilot name required for flight!"); return; }
                nameOverlay.style.display = "none";
                gameContainer.style.display = "flex";
                fetchCount();
            };

            // Fetch Logic (Original remains untouched)
            async function fetchCount() {
                try {
                    const { data, error } = await supabase
                        .from('clicks')
                        .select('*')
                        .eq('id', 1)
                        .single();

                    if (error) {
                        alert("Database Query Error: " + error.message);
                        counterDisplay.innerText = "DB Error";
                    } else if (data) {
                        updateUI(data);
                    }
                } catch (e) {
                    alert("Network/Script Crash: " + e.message);
                }
            }

            // UI Refresh Logic
            function updateUI(data) {
                counterDisplay.innerText = Math.floor(data.count);
                nameDisplay.innerText = "Last Spark By: " + (data.last_name || "Unkown");
                document.getElementById('auto-rate-val').innerText = data.auto_rate || 0;
                document.getElementById('last-purchase').innerText = "Recent Discovery: " + (data.last_purchase_name || "None");
                document.getElementById('u1-last').innerText = "Last Buyer: " + (data.last_u1_name || "None");
                document.getElementById('u2-last').innerText = "Last Buyer: " + (data.last_u2_name || "None");
                document.getElementById('u3-last').innerText = "Last Buyer: " + (data.last_u3_name || "None");
                
                const buttons = document.querySelectorAll('.buy-btn');
                const costs = [50, 400, 3000];
                buttons.forEach((btn, idx) => {
                    btn.disabled = data.count < costs[idx];
                });
            }

            // Purchase Logic
            window.buyUpgrade = async function(rateAdd, cost, column) {
                const currentCount = parseInt(counterDisplay.innerText);
                if(currentCount < cost) return;

                const { error: upError } = await supabase.from('clicks').update({
                    count: currentCount - cost,
                    auto_rate: parseFloat(document.getElementById('auto-rate-val').innerText) + rateAdd,
                    last_purchase_name: userName,
                    [`last_${column}_name`]: userName
                }).eq('id', 1);
                
                if(upError) alert("Transmission Interrupted: " + upError.message);
            }

            // Manual Click Logic
            document.getElementById('click-btn').addEventListener('click', async () => {
                const current = parseInt(counterDisplay.innerText) || 0;
                counterDisplay.innerText = current + 1; 
                nameDisplay.innerText = "Last Spark By: " + userName;

                const { error } = await supabase
                    .from('clicks')
                    .update({ 
                        count: current + 1,
                        last_name: userName
                    })
                    .eq('id', 1);

                if (error) alert("Pulse Failed: " + error.message);
            });

            // Auto-Clicker Process (Preserved)
            setInterval(async () => {
                const rate = parseFloat(document.getElementById('auto-rate-val').innerText) || 0;
                if(rate > 0) {
                    // This expects the RPC 'increment_auto_clicks' to exist in SQL
                    await supabase.rpc('increment_auto_clicks', { amount: rate });
                }
            }, 1000);

            // Realtime listener (Original logic)
            supabase.channel('any')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clicks' }, payload => {
                    if (payload.new) {
                        updateUI(payload.new);
                    }
                })
                .subscribe();
        };
    </script>
</body>
</html>
